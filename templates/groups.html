{% extends "base.html" %}
{% block title %}Grupos de Trabalho - DocCollab{% endblock %}
{% block content %}
<style>
.groups-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 350px 1fr;
  gap: 20px;
  height: calc(100vh - 60px);
}

.groups-sidebar {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 20px;
  overflow-y: auto;
}

.groups-sidebar h2 {
  margin: 0 0 20px 0;
  font-size: 1.5rem;
  color: #333;
}

.create-group-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 20px;
  transition: transform 0.2s;
}

.create-group-btn:hover {
  transform: translateY(-2px);
}

.group-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.group-item {
  padding: 15px;
  margin-bottom: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 4px solid transparent;
}

.group-item:hover {
  background: #e9ecef;
  border-left-color: #667eea;
}

.group-item.active {
  background: #e3e6f8;
  border-left-color: #667eea;
}

.group-item h4 {
  margin: 0 0 5px 0;
  font-size: 1rem;
  color: #333;
}

.group-item .role-badge {
  display: inline-block;
  padding: 2px 8px;
  background: #667eea;
  color: white;
  border-radius: 12px;
  font-size: 0.75rem;
  margin-left: 8px;
}

.chat-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  height: 100%;
}

.chat-header {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header h2 {
  margin: 0;
  font-size: 1.5rem;
  color: #333;
}

.manage-members-btn {
  padding: 8px 16px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
    cursor: pointer;
  font-size: 0.9rem;
  }

.manage-members-btn:hover {
  background: #5568d3;
  }

.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
    display: flex;
  flex-direction: column;
}

.message {
  margin-bottom: 15px;
  padding: 10px 15px;
  border-radius: 8px;
  max-width: 70%;
  word-wrap: break-word;
}

.message.mine {
  align-self: flex-end;
  background: #667eea;
    color: white;
}

.message.other {
  align-self: flex-start;
  background: #f1f3f4;
  color: #333;
}

.message.system {
  align-self: center;
  background: #fff3cd;
  color: #856404;
  font-style: italic;
  max-width: 80%;
}

.message-sender {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 0.85rem;
}

.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 5px;
}

.chat-input {
  padding: 20px;
  border-top: 1px solid #e0e0e0;
    display: flex;
  gap: 10px;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1rem;
}

.send-btn {
  padding: 12px 24px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.send-btn:hover {
  background: #5568d3;
}

.empty-state {
  flex: 1;
    display: flex;
    align-items: center;
  justify-content: center;
  flex-direction: column;
  color: #999;
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 20px;
}

/* Modal */
  .modal {
  display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
  z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
  display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 8px;
  padding: 30px;
    width: 90%;
  max-width: 500px;
}

.modal-content h3 {
  margin: 0 0 20px 0;
    font-size: 1.5rem;
  }

  .form-group {
  margin-bottom: 20px;
  }

  .form-group label {
    display: block;
  margin-bottom: 5px;
  font-weight: 600;
  color: #333;
}

.form-group input,
.form-group textarea {
    width: 100%;
  padding: 10px;
    border: 1px solid #ddd;
  border-radius: 6px;
    font-size: 1rem;
  }

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  }

  .btn {
  padding: 10px 20px;
    border: none;
  border-radius: 6px;
    cursor: pointer;
  font-weight: 600;
  }

  .btn-primary {
  background: #667eea;
    color: white;
  }

.btn-secondary {
  background: #e0e0e0;
  color: #333;
}

.members-list {
  list-style: none;
  padding: 0;
  margin: 20px 0;
}

.member-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 6px;
  margin-bottom: 10px;
}

.member-info h4 {
  margin: 0 0 5px 0;
  font-size: 1rem;
}

.member-info p {
  margin: 0;
  font-size: 0.85rem;
  color: #666;
}

.remove-btn {
  padding: 6px 12px;
  background: #dc3545;
    color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
}

.remove-btn:hover {
  background: #c82333;
}

/* Toast Notifications */
#toastContainer {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
}

.toast {
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease;
  min-width: 300px;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast.success {
  border-left: 4px solid #28a745;
}

.toast.error {
  border-left: 4px solid #dc3545;
}

.toast.warning {
  border-left: 4px solid #ffc107;
}

.toast.info {
  border-left: 4px solid #17a2b8;
}

.toast-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.toast.success .toast-icon {
  color: #28a745;
}

.toast.error .toast-icon {
  color: #dc3545;
}

.toast.warning .toast-icon {
  color: #ffc107;
}

.toast.info .toast-icon {
  color: #17a2b8;
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.toast-message {
  font-size: 0.9rem;
  color: #666;
}

.toast-close {
  background: none;
  border: none;
  font-size: 20px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.toast-close:hover {
  color: #333;
  }
</style>

<!-- Container para Toasts -->
<div id="toastContainer"></div>

<div class="groups-container">
  <!-- Sidebar: Lista de Grupos -->
  <div class="groups-sidebar">
    <h2>Meus Grupos</h2>
    <button class="create-group-btn" onclick="showCreateGroupModal()">
      <i class="fas fa-plus"></i> Criar Novo Grupo
    </button>
    
    <ul class="group-list" id="groupList">
      {% if my_groups %}
        {% for group in my_groups %}
        <li class="group-item" data-group-id="{{ group.id }}" onclick="selectGroup({{ group.id }})">
          <h4>
            {{ group.name }}
            {% for member in group.members %}
              {% if member.user_id == current_user.id %}
                <span class="role-badge">{{ '👑 Líder' if member.role == 'leader' else 'Membro' }}</span>
              {% endif %}
            {% endfor %}
          </h4>
          <p style="margin: 0; font-size: 0.85rem; color: #666;">{{ group.description or 'Sem descrição' }}</p>
        </li>
        {% endfor %}
      {% else %}
        <p style="text-align: center; color: #999;">Nenhum grupo ainda. Crie um!</p>
      {% endif %}
    </ul>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <div id="emptyState" class="empty-state">
      <i class="fas fa-comments"></i>
      <p>Selecione um grupo para começar a conversar</p>
    </div>

    <div id="chatArea" style="display: none; height: 100%; display: flex; flex-direction: column;">
      <div class="chat-header">
        <h2 id="groupName"></h2>
        <button class="manage-members-btn" id="manageMembersBtn" onclick="showMembersModal()" style="display: none;">
          <i class="fas fa-users"></i> Gerenciar Membros
        </button>
      </div>

      <div class="chat-messages" id="chatMessages"></div>

      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
        <button class="send-btn" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Criar Grupo -->
<div class="modal" id="createGroupModal" onclick="if(event.target === this) hideCreateGroupModal()">
  <div class="modal-content">
    <h3>Criar Novo Grupo</h3>
    <div class="form-group">
      <label>Nome do Grupo:</label>
      <input type="text" id="createGroupName" placeholder="Ex: Projeto Dissertação">
    </div>
    <div class="form-group">
      <label>Descrição:</label>
      <textarea id="createGroupDescription" rows="3" placeholder="Descreva o propósito do grupo..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideCreateGroupModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="createGroup()">Criar Grupo</button>
    </div>
  </div>
</div>

<!-- Modal: Gerenciar Membros -->
<div class="modal" id="membersModal" onclick="if(event.target === this) hideMembersModal()">
  <div class="modal-content">
    <h3>Gerenciar Membros</h3>
    
    <div class="form-group">
      <label>Adicionar Membro (por email):</label>
      <div style="display: flex; gap: 10px;">
        <input type="email" id="memberEmail" placeholder="email@exemplo.com">
        <button class="btn btn-primary" onclick="addMember()">Adicionar</button>
      </div>
    </div>

    <h4 style="margin-top: 30px;">Membros Atuais:</h4>
    <ul class="members-list" id="membersList"></ul>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideMembersModal()">Fechar</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let socket;
let currentGroupId = null;
let isLeader = false;

// ============================================================================
// SISTEMA DE TOAST NOTIFICATIONS
// ============================================================================

function showToast(message, type = 'info', title = '') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '✅',
    error: '❌',
    warning: '⚠️',
    info: 'ℹ️'
  };
  
  const titles = {
    success: title || 'Sucesso',
    error: title || 'Erro',
    warning: title || 'Atenção',
    info: title || 'Informação'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type]}</div>
    <div class="toast-content">
      <div class="toast-title">${titles[type]}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">×</button>
  `;
  
  container.appendChild(toast);
  
  // Auto-remover após 5 segundos
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

// Adicionar animação de saída
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// Conectar ao SocketIO
  document.addEventListener('DOMContentLoaded', () => {
  socket = io();
  
  socket.on('connect', () => {
    console.log('[Groups] Conectado ao servidor');
  });

  socket.on('group_joined', (data) => {
    console.log('[Groups] Entrou no grupo:', data.group_id);
    loadMessages(data.group_id);
  });

  socket.on('new_group_message', (data) => {
    appendMessage(data);
  });
});

function showCreateGroupModal() {
  document.getElementById('createGroupModal').classList.add('active');
}

function hideCreateGroupModal() {
  document.getElementById('createGroupModal').classList.remove('active');
  // Limpar campos
  document.getElementById('createGroupName').value = '';
  document.getElementById('createGroupDescription').value = '';
}

function showMembersModal() {
  document.getElementById('membersModal').classList.add('active');
  loadMembers();
}

function hideMembersModal() {
  document.getElementById('membersModal').classList.remove('active');
}

async function createGroup() {
  const name = document.getElementById('createGroupName').value.trim();
  const description = document.getElementById('createGroupDescription').value.trim();

  console.log('[DEBUG] createGroup() - Nome:', name, 'Descrição:', description);

  if (!name) {
    showToast('Por favor, digite o nome do grupo', 'warning');
    document.getElementById('createGroupName').focus();
    return;
  }

  try {
    console.log('[DEBUG] Enviando POST para /api/groups/create...');
    const response = await fetch('/api/groups/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description })
    });

    console.log('[DEBUG] Response status:', response.status);
      const data = await response.json();
    console.log('[DEBUG] Response data:', data);

    if (data.success) {
      console.log('[DEBUG] ✅ Grupo criado! ID:', data.group_id);
      showToast('Grupo criado com sucesso!', 'success');
      hideCreateGroupModal();
      
      // Adicionar grupo dinamicamente à lista (SEM RELOAD)
      console.log('[DEBUG] Adicionando grupo à lista...');
      addGroupToList(data.group_id, name, description, true);
      
      // Recarregar após 1 segundo (para garantir sincronização)
      console.log('[DEBUG] Recarregando página em 1 segundo...');
      setTimeout(() => window.location.reload(), 1000);
      } else {
      console.error('[DEBUG] ❌ Erro ao criar grupo:', data.error);
      showToast(data.error || 'Erro ao criar grupo', 'error');
      }
    } catch (error) {
    console.error('[DEBUG] ❌ Exceção ao criar grupo:', error);
    showToast('Erro ao criar grupo: ' + error.message, 'error');
  }
}

// Adicionar grupo à lista dinamicamente
function addGroupToList(groupId, name, description, isLeader) {
  const groupList = document.getElementById('groupList');
  
  // Remover mensagem "Nenhum grupo ainda"
  const emptyMsg = groupList.querySelector('p');
  if (emptyMsg) {
    emptyMsg.remove();
  }
  
  // Criar elemento do grupo
  const li = document.createElement('li');
  li.className = 'group-item';
  li.setAttribute('data-group-id', groupId);
  li.onclick = () => selectGroup(groupId);
  
  li.innerHTML = `
    <h4>
      ${name}
      <span class="role-badge">👑 Líder</span>
    </h4>
    <p style="margin: 0; font-size: 0.85rem; color: #666;">${description || 'Sem descrição'}</p>
  `;
  
  groupList.appendChild(li);
}

function selectGroup(groupId) {
  // Destacar grupo selecionado
  document.querySelectorAll('.group-item').forEach(item => {
    item.classList.remove('active');
  });
  event.currentTarget.classList.add('active');

  // Sair do grupo anterior
  if (currentGroupId && socket) {
    socket.emit('leave_group', { group_id: currentGroupId });
  }

  currentGroupId = groupId;

  // Entrar no novo grupo
  if (socket) {
    socket.emit('join_group', { group_id: groupId });
  }

  // Carregar informações do grupo
  loadGroupInfo(groupId);

  // Mostrar área de chat
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('chatArea').style.display = 'flex';
}

async function loadGroupInfo(groupId) {
  try {
    const response = await fetch(`/api/groups/${groupId}/members`);
    const data = await response.json();

    if (data.success) {
      isLeader = data.is_leader;
      
      // Mostrar botão de gerenciar apenas para líderes
      document.getElementById('manageMembersBtn').style.display = isLeader ? 'block' : 'none';
      
      // Atualizar nome do grupo
      const groupItem = document.querySelector(`.group-item[data-group-id="${groupId}"] h4`);
      if (groupItem) {
        document.getElementById('groupName').textContent = groupItem.textContent.replace('👑 Líder', '').replace('Membro', '').trim();
      }
    }
  } catch (error) {
    console.error('Erro ao carregar informações do grupo:', error);
  }
}

async function loadMessages(groupId) {
  try {
    const response = await fetch(`/api/groups/${groupId}/messages`);
    const data = await response.json();

    if (data.success) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      data.messages.forEach(msg => appendMessage(msg));
    }
  } catch (error) {
    console.error('Erro ao carregar mensagens:', error);
  }
}

function appendMessage(msg) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  
  if (msg.type === 'system') {
    messageDiv.className = 'message system';
    messageDiv.textContent = msg.message;
  } else {
    messageDiv.className = `message ${msg.is_mine ? 'mine' : 'other'}`;
    messageDiv.innerHTML = `
      ${!msg.is_mine ? `<div class="message-sender">${msg.user_name}</div>` : ''}
      <div>${msg.message}</div>
      <div class="message-time">${new Date(msg.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
    `;
  }
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();

  if (!message || !currentGroupId) return;

  socket.emit('send_group_message', {
    group_id: currentGroupId,
    message: message
  });

  input.value = '';
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
}

async function loadMembers() {
  if (!currentGroupId) return;

  try {
    const response = await fetch(`/api/groups/${currentGroupId}/members`);
    const data = await response.json();

    if (data.success) {
      const membersList = document.getElementById('membersList');
      membersList.innerHTML = '';

      data.members.forEach(member => {
        const li = document.createElement('li');
        li.className = 'member-item';
        li.innerHTML = `
          <div class="member-info">
            <h4>${member.name} ${member.role === 'leader' ? '👑' : ''}</h4>
            <p>${member.email}</p>
          </div>
          ${isLeader && member.role !== 'leader' ? `
            <button class="remove-btn" onclick="removeMember(${member.id})">
              <i class="fas fa-trash"></i> Remover
            </button>
          ` : ''}
        `;
        membersList.appendChild(li);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar membros:', error);
  }
}

async function addMember() {
  const email = document.getElementById('memberEmail').value.trim();

  if (!email) {
    showToast('Por favor, digite um email', 'warning');
    document.getElementById('memberEmail').focus();
      return;
    }

    try {
    const response = await fetch(`/api/groups/${currentGroupId}/members/add`, {
        method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (data.success) {
      showToast(data.message, 'success');
      document.getElementById('memberEmail').value = '';
      loadMembers();
      } else {
      showToast(data.error || 'Erro ao adicionar membro', 'error');
      }
    } catch (error) {
    showToast('Erro ao adicionar membro: ' + error.message, 'error');
  }
}

async function removeMember(memberId) {
  if (!confirm('Tem certeza que deseja remover este membro?')) return;

  try {
    const response = await fetch(`/api/groups/${currentGroupId}/members/${memberId}/remove`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (data.success) {
      showToast(data.message, 'success');
      loadMembers();
    } else {
      showToast(data.error || 'Erro ao remover membro', 'error');
    }
  } catch (error) {
    showToast('Erro ao remover membro: ' + error.message, 'error');
  }
  }
</script>
{% endblock %}
